trigger:
- development

pool:
  name: pusula-akademi-team2-agent

name: $(Date:yyyyMMdd).$(Rev:r)

variables:
  dateTimeTag: "$(Build.SourceVersion:0:7)-$(Build.QueuedTime:yyyy-MM-dd-HH.mm)"
  validImageTag: "$(Build.SourceVersion:0:7)-$(Build.QueuedTime:yyyyMMdd-HHmm)"
  imageTag: "$(validImageTag)"

steps:
- task: Docker@2
  displayName: 'Docker Image Build'
  inputs:
    repository: 'Blazorapp'
    command: 'build'
    Dockerfile: '**/Dockerfile-BlazorApp'
    tags: $(imageTag)
    buildArguments: '--memory=4g --cpu-shares=1024'

- task: Bash@3
  displayName: 'Imageâ€™i Tagle'
  inputs:
    targetType: 'inline'
    script: |
      docker tag blazorapp:$(imageTag) registry.gitlab.com/medplus1/medplusproject:$(imageTag)

- task: Docker@2
  displayName: 'Docker Image Push'
  inputs:
    containerRegistry: 'GitLab'
    repository: 'medplus1/medplusproject'
    command: 'push'
    tags: '$(imageTag)'
