trigger:
- development

pool:
  name: pusula-akademi-team2-agent

name: $(Date:yyyyMMdd).$(Rev:r)

variables:
  imageTag: "$(Build.BuildNumber)"

stages:
  - stage: SonarQubeAnalysis
    displayName: SonarQube Analysis
    jobs:
      - job: AnalyzeCode
        displayName: Run SonarQube Analysis
        steps:

          - task: SonarQubePrepare@5
            inputs:
              SonarQube: 'sonarqube'
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: 'Pusula.Training.HealthCare'
              cliProjectName: 'Pusula.Training.HealthCare'
              cliProjectVersion: '1.0'
              cliSources: '.'

          - script: |
              "$(SonarPath)/sonar-scanner"
            displayName: Run SonarQube Scanner

          - task: SonarQubePublish@5
            inputs:
              pollingTimeoutSec: '300'

  - stage: BuildDockerImage
    displayName: Build Docker Image
    jobs:
      - job: BuildImage
        displayName: Build Blazor Docker Image
        steps:
          - task: Docker@2
            inputs:
              repository: 'Blazorapp'
              command: 'build'
              Dockerfile: '**/Dockerfile-BlazorApp'
              tags: $(imageTag)
              buildArguments: '--memory=4g --cpu-shares=1024'

  - stage: DockerImageSecurityScan
    displayName: Docker Image Security Scan
    jobs:
      - job: SecurityScan
        displayName: Run Trivy Security Scan
        steps:
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                echo "### Trivy Kurulumu Başlatılıyor..."
                sudo apt-get update
                sudo apt-get install wget apt-transport-https gnupg -y
                wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
                echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
                sudo apt-get update
                sudo apt-get install trivy -y
                echo "### Docker Image Güvenlik Taraması Başlatılıyor..."
                trivy image registry.gitlab.com/medplus1/medplusproject:$(imageTag) --exit-code 0 --severity HIGH,CRITICAL
                echo "### CRITICAL ve HIGH Seviyedeki Güvenlik Açıkları Kontrol Ediliyor..."
                trivy image registry.gitlab.com/medplus1/medplusproject:$(imageTag) --exit-code 1 --severity CRITICAL
            displayName: 'Docker Image Trivy Taraması'

  - stage: TagAndRemoveImage
    displayName: Tag and Remove Docker Image
    jobs:
      - job: TagAndRemove
        displayName: Tag and Remove Blazor Docker Image
        steps:
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                docker tag blazorapp:$(imageTag) registry.gitlab.com/medplus1/medplusproject:$(imageTag)
                docker rmi blazorapp:$(imageTag)

  - stage: PushDockerImage
    displayName: Push Docker Image to GitLab
    jobs:
      - job: PushImage
        displayName: Push Docker Image to GitLab Registry
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: 'GitLab'
              repository: 'medplus1/medplusproject'
              command: 'push'
              tags: '$(imageTag)'

